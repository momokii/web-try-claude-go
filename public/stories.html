{{ template "base/base-header" . }}

<body>

    <div class="container">
        <!--====== PRICING STYLE ONE START ======-->
        <section class="pricing-area pricing-one">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-xxl-6 col-xl-7 col-lg-8">
                        <div class="section-title text-center">
                            <h2 class="mb-3 fw-bold">Create Your Own Stories</h2>
                            <p class="text-lg">
                                Create a story with your own chosen plot using the Claude Sonnet 3.5 API or GPT-4. Choose a theme and we will create the initial story, then you can continue the story with the choices we provide. At the end of the process, when the story is complete, we will create an illustration of your story and an audio version of the created story.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-10 col-md-10 col-sm-10" id="cardInput">
                        <div class="pricing-style-one d-flex flex-column h-100">
                            <div class="pricing-header text-center">
                                <h3 class="sub-title">Create Your Own Stories</h3>
                                <h6 class="year mt-3 text-center text-danger">Feature Credit Cost: 3 credits</h6>
                                <h6 id="subtitle_card" class="year mt-3 text-justify">Try selecting an available theme and create your own story.</h6>

                                <div class="form-style form-style-five ">
                                    <div class="row">
                                        <div class="col-lg-12 justify-content-center">
                                            <div class="form-input mt-4" id="input_theme">
                                                <div class="mb-3">
                                                    <small for="theme" class="form-text text-muted text-left fw-bold">Theme</small>
                                                    <select name="theme" id="theme" class="form-select mb-3">
                                                        <option value="Romance Comedy">Romance Comedy</option>
                                                        <option value="Fantasy">Fantasy</option>
                                                        <option value="Science Fiction">Science Fiction</option>
                                                        <option value="Mystery">Mystery</option>
                                                        <option value="Horror">Horror</option>
                                                        <option value="Adventure">Adventure</option>
                                                        <option value="Fable">Fable</option>
                                                        <option value="Drama">Drama</option>
                                                        <option value="Action">Action</option>
                                                        <option value="Thriller/Psychological Thriller">Thriller/Psychological Thriller</option>
                                                    </select>
                                                </div>

                                                <div class="mb-3">
                                                    <small for="language" class="form-text text-muted text-left fw-bold">Language</small>
                                                    <select name="language" id="language" class="form-select mb-3">
                                                        <option value="indonesia">Indonesia</option>
                                                        <option value="english">English</option>
                                                    </select>
                                                </div>

                                                <div class="mb-3">
                                                    <small for="user-action" class="form-text text-muted text-left fw-bold">Total User Action Interaction</small>
                                                    <select name="user-action" id="user-action" class="form-select mb-3">
                                                        <option value="4">4</option>
                                                        <option value="6">6</option>
                                                        <option value="8">8</option>
                                                        <option value="10">10</option>
                                                    </select>
                                                </div>

                                                <div class="mb-3">
                                                    <small for="model" class="form-text text-muted text-left fw-bold">LLM Model</small>
                                                    <select name="model" id="model" class="form-select mb-3">
                                                        <option value="claude">Claude</option>
                                                        <option value="gpt">GPT</option>
                                                    </select>
                                                </div>

                                                <div class="pricing-btn rounded-buttons text-center">
                                                    <button id="submit_title" class="btn primary-btn rounded-full">
                                                        Submit
                                                    </button>
                                                </div>
                                            </div>

                                            <div>
                                                <div id="title-selection" style="display: none;" class="mt-4">
                                                    <h4 class="mb-3">Choose a Title</h4>
                                                    <div id="title-options" class="d-flex flex-column align-items-center"></div>
                                                </div>
                                                <div id="story-progress" style="display: none;" class="mt-4">
                                                    <h5>Your Story</h5>
                                                    <h3 id="title_story">Title</h3>
                                                    <h5 id="theme_story">Theme</h5>
                                                    <h5 id="model_choose">Model</h5>
                                                    <p id="story-description" class=" text-center">description</p> <!-- Tambahkan deskripsi cerita -->
                                                    
                                                    <!-- when still need choices -->
                                                    <div id="story-progress-content">
                                                        <!-- <div id="story-content" class="mb-4 text-justify"></div> -->
                                                        <pre id="story-content" class="mb-4 text-justify" style="font-family: inherit; font-size: 1rem; color: #6c757d; white-space: pre-wrap; background: none; border: none; padding: 0; margin: 0;">
                                                        </pre>
                                                        <br>
                                                        <h5>Your Next Action Choices: </h5>
                                                        <div id="story-choices"></div>
                                                    </div>

                                                    <!-- final story all -->
                                                    <div id="final-story" style="display: none;">

                                                        <div id="preview-container-result" class="mt-3" style="text-align: center;">
                                                            <!-- Link untuk membuka atau mengunduh gambar ukuran penuh -->
                                                            <a id="fullsize-link" href="#" target="_blank" download>
                                                                <img id="result-image" src="#" alt="Image Result" style="display: none; max-width: 85%; height: auto; margin: 20px auto;">
                                                            </a>
                                                            
                                                            <!-- Audio -->
                                                            <audio id="result-audio" controls style="display: none; margin: 20px auto; display: block;">
                                                                Your browser does not support the audio element.
                                                            </audio>
                                                        </div>

                                                        <h5>Your Completed Story</h5>
                                                        <!-- <div id="full-story" class="mb-4 text-justify"></div> -->

                                                        <pre id="full-story" class="mb-4 text-justify" style="font-family: inherit; font-size: 1rem; color: #6c757d; white-space: pre-wrap; background: none; border: none; padding: 0; margin: 0;">
                                                            Content Data
                                                        </pre>

                                                        <div class="pricing-btn rounded-buttons text-center">
                                                            <a class="btn primary-btn rounded-full" href="/stories">
                                                                Repeat
                                                            </a>
                                                        </div>

                                                    </div>
                                                    
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
    
                            <div class="bottom-shape">
                                <svg data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 350 112.35">
                                    <defs>
                                        <style>
                                            .color-1 {
                                                fill: #2bdbdc;
                                                isolation: isolate;
                                            }

                                            .cls-1 {
                                                opacity: 0.1;
                                            }

                                            .cls-2 {
                                                opacity: 0.2;
                                            }

                                            .cls-3 {
                                                opacity: 0.4;
                                            }

                                            .cls-4 {
                                                opacity: 0.6;
                                            }
                                        </style>
                                    </defs>
                                    <title>bottom-part1</title>
                                    <g>
                                        <g data-name="Group 747">
                                            <path data-name="Path 294" class="cls-1 color-1"
                                                d="M0,24.21c120-55.74,214.32,2.57,267,0S349.18,7.4,349.18,7.4V82.35H0Z"
                                                transform="translate(0 0)" />
                                            <path data-name="Path 297" class="cls-2 color-1"
                                                d="M350,34.21c-120-55.74-214.32,2.57-267,0S.82,17.4.82,17.4V92.35H350Z"
                                                transform="translate(0 0)" />
                                            <path data-name="Path 296" class="cls-3 color-1"
                                                d="M0,44.21c120-55.74,214.32,2.57,267,0S349.18,27.4,349.18,27.4v74.95H0Z"
                                                transform="translate(0 0)" />
                                            <path data-name="Path 295" class="cls-4 color-1"
                                                d="M349.17,54.21c-120-55.74-214.32,2.57-267,0S0,37.4,0,37.4v74.95H349.17Z"
                                                transform="translate(0 0)" />
                                        </g>
                                    </g>
                                </svg>
                            </div>
                        </div>
                        <!-- single pricing -->
                    </div>

                </div>
                <!-- row -->
            </div>
            <!-- container -->
        </section>
        <!--====== PRICING STYLE ONE ENDS ======-->

        <div class="row justify-content-center">
            <div>
                <div class="pricing-btn rounded-buttons text-center mb-5">
                    <a class="btn btn-danger rounded-full" href="/">
                        Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    {{ template "base/footer" . }}

    {{ template "components/loading" .}}

    {{ template "components/modal-infor" .}}
</body>

<script>
    const modalInfo = new bootstrap.Modal(document.getElementById('infoModal'));

    $(document).ready(async function () {
        // init story data 
        const storyParts = {
            title: null,
            description: null,
            theme: null,
            language: null,
            paragraph: '',
            choice: null,
            MAX_INTERACTION: 5,
            model: 'claude'
        }
        let INTERACTION_NOW = 0
        let DATA_B64_AUDIO_FULL_STORIES = ""
        let MAX_TTS_TRY = 5
        let theme 
        let language

        // create TTS from every part of user choices
        // use every part instead of full story to avoid the MAX prompt on TTS (4096 character)
        async function createAudioPartTTS(prompt) {
            const url_tts = "/api/creative-content/audio/speech"

            try {
                const response = await fetch(url_tts, {
                    method: "POST",
                    headers: {
                        "Content-Type" : "application/json",
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        language: storyParts.language,
                    })
                })
                const res = await response.json()

                if(res.error) {
                    throw new Error(res.message)
                }
                // add audio part to all audio data
                DATA_B64_AUDIO_FULL_STORIES += res.data.b64_json

                return false

            } catch (e) {
                return true 
            }
        }

        // update story will update add new paragraph and add new choices
        async function updateStory(paragraph, choices) {
            // first trying convert paragraph to audio
            let is_fail = true 
            let try_num = 1
            while (is_fail && (try_num <= MAX_TTS_TRY)) {
                is_fail = await createAudioPartTTS(paragraph)
                try_num++
            }

            if (is_fail) {
                INTERACTION_NOW--
                throw new Error("Failed to create audio for this story, please try again")
            }
            
            storyParts.paragraph += '<br><br>' + paragraph
            storyParts.choice = choices

            const storyContainer = $('#story-content')
            storyContainer.html(storyParts.paragraph)

            const choiceContainer = $('#story-choices')
            choiceContainer.html('')

            choices.forEach(choice => {
                const button = $('<button></button>')
                button.text(choice)
                button.addClass('btn btn-primary m-2')
                button.on('click', async function() {
                    try {
                        await makeChoice(choice)
                    } catch(e) {
                        $('#modalMessage').html(e.message)
                        modalInfo.show()
                    }
                })

                choiceContainer.append(button)
            })
        }

        // first interaction user select title
        // will send request to server to get first paragraph and choices        
        async function selectTitle(title, description) {
            storyParts.title = title
            storyParts.description = description
            storyParts.theme = theme
            storyParts.language = language
            storyParts.MAX_INTERACTION = parseInt($('#user-action').val() ?? 4) + 1

            $('#title-selection').css('display', 'none')
            $('#story-progress').css('display', 'block')

            $('#title_story').html(storyParts.title) // update title 
            $('#story-description').html(storyParts.description) // update description
            $('#theme_story').html(`(${storyParts.theme})`) // update theme
            $('#model_choose').html(`Model: ${storyParts.model.toUpperCase()}`) // update model

            $('#loadingModal').css('display', 'flex')

            const url = '/api/stories/paragraphs' + "?model=" + storyParts.model

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(storyParts)
                })
                const res = await response.json()

                if (res.error) {
                    throw new Error(res.message)
                } else {
                    await updateStory(res.data.paragraph, res.data.choices)
                    INTERACTION_NOW++
                }

            } catch(e) {
                $('#modalMessage').html(e.message)
                modalInfo.show()
            } finally {
                $('#loadingModal').css('display', 'none')
            }
        }

        // make choice will send request to server to get next paragraph and choices
        // if interaction now is more than max interaction will end the story
        async function makeChoice(choice) {
            storyParts.choice = choice
            INTERACTION_NOW++
            let api = INTERACTION_NOW >= storyParts.MAX_INTERACTION ? 'end' : 'next'

            $('#loadingModal').css('display', 'flex')
            const url = '/api/stories/paragraphs/' + api + "?model=" + storyParts.model

            try {
                const response = await fetch(url , {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(storyParts)
                })
                const res = await response.json()

                if (res.error) {
                    throw new Error(res.message)
                } else {
                    await updateStory(res.data.paragraph, res.data.choices)

                    if (api === 'end') {
                        // create image illustration
                        // create image for stroy illustration
                        let prompt_image = `
                            Sebuah cerita dengan judul: ${storyParts.title}.
                            Genre Cerita: ${storyParts.theme}.
                            Deskripsi Cerita: ${storyParts.description}.

                            Petunjuk Tambahan:
                            - Jika tidak meningkatkan estetika, hindari penambahan teks deskriptif pada gambar akhir.
                        `

                        const url_images = "/api/creative-content/images/generations"
                        const response_image = await fetch(url_images, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                prompt: prompt_image,
                            })
                        })
                        const res_image = await response_image.json()

                        // process image and show it 
                        if (res_image.data.image_data) {
                            const b64_image = "data:image/png;base64," + res_image.data.image_data.data[0].b64_json

                            // show image
                            $('#result-image').attr('src', b64_image).css('display', 'block')
                            $('#fullsize-link').attr('href', b64_image).attr('download', 'image.png')
                        }

                        // process audio ver 
                        const b64_audio = "data:audio/mp3;base64," + DATA_B64_AUDIO_FULL_STORIES

                        // show audio ver
                        $('#result-audio').attr('src', b64_audio).css('display', 'block')

                        $('#story-progress-content').css('display', 'none')
                        $('#final-story').css('display', 'block')
                        $('#full-story').html(storyParts.paragraph)
                    } 
                }

            } catch(e) {
                $('#modalMessage').html(e.message)
                modalInfo.show()
            } finally {
                $('#loadingModal').css('display', 'none')
            }
        }

        // submit title will send request to server to get list of title
        // with theme and language that user choose
        $('#submit_title').on('click', async function () {

            $('#loadingModal').css('display', 'flex')

            theme = $('#theme').val()
            language = $('#language').val()
            const model = $('#model').val()
            storyParts.model = model

            const url = '/api/stories/titles?model=' + model

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        theme,
                        language
                    })
                })
                const res = await response.json()

                if(res.error) {
                    throw new Error(res.message)

                } else {
                    const titleOpt = $('#title-options')
                    titleOpt.html('')
                    res.data.titles.forEach(data => {
                        const button =  $('<button></button>')
                        button.text(data.title)
                        button.addClass('btn btn-primary m-2')
                        button.on('click', async function() {
                            try {
                                await selectTitle(data.title, data.description)
                            } catch(e) {
                                throw e
                            }
                        })

                        // Bungkus button dan deskripsi dalam div
                        const buttonWrapper = $('<div></div>');
                        buttonWrapper.append(button);

                        titleOpt.append(button)
                    })

                    $('#title-selection').css('display', 'block')
                    $('#input_theme').css('display', 'none')
                    $('#subtitle_card').css('display', 'none')
                }

            } catch(e) {
                $('#modalMessage').html(e.message)
                modalInfo.show()
            } finally {
                $('#loadingModal').css('display', 'none')
            }
            
        })

    })
</script>

</html>